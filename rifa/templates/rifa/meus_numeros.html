{% extends 'rifa/base.html' %}

{% block title %}Meus N√∫meros{% endblock %}

{% block content %}
<section class="d-flex justify-content-center align-items-center" style="min-height: 80vh;" data-aos="fade-up">
  <div class="glass-login w-100" style="max-width: 500px;">
    <h3 class="mb-3 text-center"><span style="font-size:1.3em;">üîé</span> Consultar Meus N√∫meros</h3>
    
    <div class="mb-3">
      <label for="inputCpf" class="form-label">Digite seu CPF</label>
      <input type="text" class="form-control" id="inputCpf" placeholder="000.000.000-00" 
        style="color: #fff !important; background-color: #1e1e1e !important;">
    </div>
    <button type="button" class="btn btn-primary w-100 mb-3" id="btnBuscarCpf">Buscar Meus N√∫meros</button>
    
    <div class="text-center">
      <button class="btn btn-link text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#buscaTelefone">
        <small>Ou buscar por telefone</small>
      </button>
    </div>
    
    <div class="collapse mt-3" id="buscaTelefone">
      <div class="mb-3">
        <label for="inputTelefone" class="form-label">Digite seu Telefone</label>
        <input type="text" class="form-control" id="inputTelefone" placeholder="(99) 99999-9999" 
          style="color: #fff !important; background-color: #1e1e1e !important;">
      </div>
      <button type="button" class="btn btn-secondary w-100" id="btnBuscarTelefone">Buscar por Telefone</button>
    </div>
    
    <div id="resultados" class="mt-4"></div>
  </div>
</section>

<script>
(function() {
  function getCookie(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
  }

  function formatarValorBRL(valor) {
    return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
  }

  function exibirResultados(data) {
    var resultDiv = document.getElementById('resultados');
    
    if (data.status === 'success') {
      var html = '<div class="alert alert-success mt-3">Encontrados ' + data.numeros.length + ' n√∫meros</div>';
      
      var rifas = {};
      for (var i = 0; i < data.numeros.length; i++) {
        var n = data.numeros[i];
        if (!rifas[n.rifa_titulo]) rifas[n.rifa_titulo] = [];
        rifas[n.rifa_titulo].push(n);
      }
      
      for (var titulo in rifas) {
        var nums = rifas[titulo];
        html += '<div class="card mb-3"><div class="card-header"><h6>' + titulo + '</h6></div><div class="card-body">';
        
        for (var j = 0; j < nums.length; j++) {
          var num = nums[j];
          var badge = num.status === 'Pago' ? 'success' : 'warning';
          
          html += '<div class="border rounded p-2 mb-2"><div class="row align-items-center">';
          html += '<div class="col-auto"><span class="badge bg-primary">' + num.numero + '</span></div>';
          html += '<div class="col"><span class="badge bg-' + badge + '">' + num.status + '</span>';
          
          if (num.status === 'Reservado' && num.tempo_restante > 0) {
            var h = Math.floor(num.tempo_restante / 3600);
            var m = Math.floor((num.tempo_restante % 3600) / 60);
            html += '<br><small class="text-warning">' + h + 'h ' + m + 'min restantes</small>';
          }
          
          html += '</div>';
          
          // SOLU√á√ÉO: Em vez de abrir modal, redirecionar para p√°gina de pagamento
          if (num.status === 'Reservado' && num.pedido_id) {
            html += '<div class="col-auto">';
            html += '<a href="/pedido/' + num.pedido_id + '/pagar/" class="btn btn-success btn-sm">Pagar</a>';
            html += '</div>';
          }
          
          html += '</div></div>';
        }
        
        html += '</div></div>';
      }
      
      resultDiv.innerHTML = html;
    } else {
      resultDiv.innerHTML = '<div class="alert alert-warning mt-3">' + (data.message || 'Nenhum n√∫mero encontrado') + '</div>';
    }
  }

  document.getElementById('btnBuscarCpf').onclick = function() {
    var cpf = document.getElementById('inputCpf').value.trim();
    var resultDiv = document.getElementById('resultados');
    
    if (!cpf) {
      resultDiv.innerHTML = '<div class="alert alert-warning mt-3">Digite o CPF</div>';
      return;
    }
    
    resultDiv.innerHTML = '<div class="alert alert-info mt-3">Buscando...</div>';
    
    var fd = new FormData();
    fd.append('cpf', cpf);
    
    fetch('/buscar-pedidos-cpf/', {
      method: 'POST',
      body: fd,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    })
    .then(function(r) { return r.json(); })
    .then(exibirResultados)
    .catch(function(e) {
      console.error(e);
      resultDiv.innerHTML = '<div class="alert alert-danger mt-3">Erro de conex√£o</div>';
    });
  };

  var cpfInput = document.getElementById('inputCpf');
  cpfInput.addEventListener('input', function(e) {
    var v = e.target.value.replace(/\D/g, '');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    e.target.value = v;
  });
})();
</script>
{% endblock %}