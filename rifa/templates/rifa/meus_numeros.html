{% extends 'rifa/base.html' %}

{% block title %}Meus N√∫meros{% endblock %}

{% block content %}
<section class="d-flex justify-content-center align-items-center" style="min-height: 80vh;" data-aos="fade-up">
  <div class="glass-login w-100" style="max-width: 500px;">
    <h3 class="mb-3 text-center"><span style="font-size:1.3em;">üîé</span> Consultar Meus N√∫meros</h3>
    <form id="buscar-form" autocomplete="off">
      <div class="mb-3">
        <label for="inputCpf" class="form-label">Digite seu CPF</label>
        <input type="text" class="form-control" id="inputCpf" name="cpf" placeholder="000.000.000-00" style="color: #fff !important; background-color: #1e1e1e !important;">
      </div>
      <button type="submit" class="btn btn-primary w-100">Buscar Meus N√∫meros</button>
    </form>
    
    <!-- Op√ß√£o alternativa para busca por telefone -->
    <div class="text-center mt-3">
      <button class="btn btn-link text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#buscaTelefone" aria-expanded="false">
        <small>Ou buscar por telefone</small>
      </button>
    </div>
    
    <div class="collapse mt-3" id="buscaTelefone">
      <form id="buscar-telefone-form" autocomplete="off">
        <div class="mb-3">
          <label for="inputTelefone" class="form-label">Digite seu Telefone</label>
          <input type="text" class="form-control" id="inputTelefone" name="telefone" placeholder="(99) 99999-9999" style="color: #fff !important; background-color: #1e1e1e !important;">
        </div>
        <button type="submit" class="btn btn-secondary w-100">Buscar por Telefone</button>
      </form>
    </div>
    
    <div id="resultados" class="mt-4"></div>
  </div>
</section>

<script>
// Fun√ß√£o para exibir resultados
function exibirResultados(data) {
  const resultadosDiv = document.getElementById('resultados');
  
  if (data.status === 'success') {
    let html = `<div class="alert alert-success mt-3">‚úÖ Encontrados ${data.numeros.length} n√∫mero(s):</div>`;
    html += `<div class="mt-3">`;
    
    // Agrupar por rifa
    const rifas = {};
    data.numeros.forEach(numero => {
      if (!rifas[numero.rifa_titulo]) {
        rifas[numero.rifa_titulo] = [];
      }
      rifas[numero.rifa_titulo].push(numero);
    });
    
    Object.entries(rifas).forEach(([rifaTitulo, numeros]) => {
      html += `<div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0"><strong>Rifa:</strong> ${rifaTitulo}</h6>
        </div>
        <div class="card-body">`;
      
      numeros.forEach(numero => {
        const statusClass = numero.status === 'Pago' ? 'success' : numero.status === 'Reservado' ? 'warning' : 'secondary';
        
        html += `
          <div class="border rounded p-2 mb-2">
            <div class="row align-items-center">
              <div class="col-auto">
                <span class="badge bg-primary fs-6">${numero.numero}</span>
              </div>
              <div class="col">
                <small class="text-muted">Status:</small>
                <span class="badge bg-${statusClass}">${numero.status}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += `</div></div>`;
    });
    
    html += `</div>`;
    resultadosDiv.innerHTML = html;
    
  } else if (data.status === 'not_found') {
    resultadosDiv.innerHTML = `<div class="alert alert-warning mt-3">‚ùå ${data.message}</div>`;
  } else {
    resultadosDiv.innerHTML = `<div class="alert alert-danger mt-3">‚ùå ${data.message || 'Erro ao buscar os n√∫meros.'}</div>`;
  }
}

// Busca por CPF
document.getElementById('buscar-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const cpf = document.getElementById('inputCpf').value.trim();
  const resultadosDiv = document.getElementById('resultados');
  
  // Valida√ß√£o
  if (!cpf) {
    resultadosDiv.innerHTML = `<div class="alert alert-warning mt-3">‚ö†Ô∏è Por favor, digite o CPF.</div>`;
    return;
  }
  
  // Mostrar loading
  resultadosDiv.innerHTML = `<div class="alert alert-info mt-3">üîÑ Buscando n√∫meros vinculados ao CPF <b>${cpf}</b>...</div>`;
  
  // Preparar dados
  const formData = new FormData();
  formData.append('cpf', cpf);
  
  // Fazer requisi√ß√£o AJAX
  fetch('{% url "buscar_pedidos_cpf" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => exibirResultados(data))
  .catch(error => {
    console.error('Erro:', error);
    resultadosDiv.innerHTML = `<div class="alert alert-danger mt-3">‚ùå Erro de conex√£o. Tente novamente.</div>`;
  });
});

// Busca por telefone (alternativa)
document.getElementById('buscar-telefone-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const telefone = document.getElementById('inputTelefone').value.trim();
  const resultadosDiv = document.getElementById('resultados');
  
  // Valida√ß√£o
  if (!telefone) {
    resultadosDiv.innerHTML = `<div class="alert alert-warning mt-3">‚ö†Ô∏è Por favor, digite o n√∫mero do telefone.</div>`;
    return;
  }
  
  // Mostrar loading
  resultadosDiv.innerHTML = `<div class="alert alert-info mt-3">üîÑ Buscando n√∫meros vinculados ao telefone <b>${telefone}</b>...</div>`;
  
  // Preparar dados
  const formData = new FormData();
  formData.append('telefone', telefone);
  
  // Fazer requisi√ß√£o AJAX
  fetch('{% url "buscar_pedidos" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => exibirResultados(data))
  .catch(error => {
    console.error('Erro:', error);
    resultadosDiv.innerHTML = `<div class="alert alert-danger mt-3">‚ùå Erro de conex√£o. Tente novamente.</div>`;
  });
});
</script>

<!-- M√°scaras -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Aplicar m√°scaras
  Inputmask({ mask: '999.999.999-99', showMaskOnHover: false }).mask('#inputCpf');
  Inputmask({ mask: '(99) 99999-9999', showMaskOnHover: false }).mask('#inputTelefone');
});
</script>
{% endblock %}