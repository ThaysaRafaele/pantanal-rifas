{% extends 'rifa/base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width:720px;margin:3rem auto;">
  <div class="card p-4">
    <h3>Pagamento - Pedido #{{ pedido.id }}</h3>
    <p>Expira em: <span id="pedidoExpires">{{ pedido.expires_at }}</span></p>

    <ol>
      <li>Copie o código PIX abaixo.</li>
      <li>Abra o app do seu banco e cole o código na opção PIX copia e cola.</li>
      <li>Confirme o pagamento e aguarde a confirmação automática.</li>
    </ol>

    <div style="margin:1rem 0">
      {% if pedido.pix_qr_base64 %}
        <p><strong>Código copia e cola:</strong></p>
        <textarea readonly class="form-control" style="font-family:monospace; min-height:70px;">{{ pedido.pix_codigo }}</textarea>
        <button id="btnCopy" class="btn btn-success mt-2" style="width:100%">Copiar código PIX</button>
      {% else %}
        <input id="pixRaw" type="text" readonly class="form-control" style="font-family:monospace;" value="{{ pedido.pix_codigo }}">
        <button id="btnCopy" class="btn btn-success mt-2" style="width:100%">Copiar código PIX</button>
      {% endif %}
    </div>

    <p style="text-align:center;margin:1rem 0;">Valor a ser pago: <strong>R$ {{ pedido.valor_total }}</strong></p>

    <div style="text-align:center;">
      {% if pedido.pix_qr_base64 %}
        <img src="data:image/png;base64,{{ pedido.pix_qr_base64 }}" alt="QR Code PIX" style="max-width:260px; border:1px solid #ddd; padding:8px; background:#fff;" />
        <p style="margin-top:8px;"><a href="data:image/png;base64,{{ pedido.pix_qr_base64 }}" download="qr_{{ pedido.id }}.png">Baixar QR</a></p>
      {% else %}
        <div id="qrWrap">
          <p id="qrStatus">Gerando QR...</p>
          <img id="qrImg" src="" alt="QR Code PIX" style="display:none; max-width:260px; border:1px solid #ddd; padding:8px; background:#fff;" />
        </div>
        <p style="margin-top:8px;"><a id="downloadQr" href="#" download="qr_{{ pedido.id }}.png" style="display:none;">Baixar QR</a></p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    const pedidoId = {{ pedido.id }};
    const qrImg = document.getElementById('qrImg');
    const qrStatus = document.getElementById('qrStatus');
    const download = document.getElementById('downloadQr');
    const pixRaw = document.getElementById('pixRaw');
    document.getElementById('btnCopy').addEventListener('click', ()=>{
      try {
        pixRaw.select(); navigator.clipboard.writeText(pixRaw.value);
        alert('Código PIX copiado para área de transferência');
      } catch(e){ console.warn(e); }
    });

    async function fetchQr(){
      try{
        const resp = await fetch('/api/gerar-qr/', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({pedido_id: pedidoId})
        });
        const data = await resp.json();
        if(data && data.qr_code_base64){
          qrImg.src = 'data:image/png;base64,' + data.qr_code_base64;
          qrImg.style.display = 'inline-block';
          download.href = qrImg.src; download.style.display='inline-block';
          qrStatus.style.display='none';
        } else if(data && data.qr_code){
          qrStatus.textContent = data.qr_code;
        } else {
          qrStatus.textContent = 'Não foi possível gerar o QR.';
        }
      }catch(e){
        console.error(e); qrStatus.textContent = 'Erro ao gerar QR.';
      }
    }

    // Se o pedido já tiver um QR salvo no servidor, poderia ser exibido direto.
    // Aqui simplificamos: sempre chamamos a API para obter o QR.
    fetchQr();
  })();
</script>

{% endblock %}
