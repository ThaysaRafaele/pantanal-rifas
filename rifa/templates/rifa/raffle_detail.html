{% extends 'rifa/base.html' %}
{% load static %}
{% block title %}{{ rifa.titulo }} - A√ß√£o{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/raffle_detail.css' %}">
<style>
  /* Anima√ß√£o combinada: pisca e sobe/desce */
  @keyframes blinkMove {
    0%,100% { opacity:1; transform:translateY(0); }
    50% { opacity:.35; transform:translateY(-7px); }
  }
  .blink-badge { animation: blinkMove 1.2s ease-in-out infinite; }

  .raffle-img-box { position:relative; display:inline-block; }

  /* Novo posicionamento bem ao lado da imagem */
  .badge-adquira {
    position:absolute;
    top:10px;
    left:100%;           /* come√ßa exatamente na borda direita da imagem */
    margin-left:26px;    /* empurra para fora */
    white-space:nowrap;
  }

  @media (max-width:576px){
    .badge-adquira {
      margin-left:14px;  /* aproxima no mobile para n√£o cortar */
      top:6px;
    }
  }

  /* Anima√ß√£o pre√ßo */
  .price-line{display:flex;justify-content:center;align-items:center;gap:.55rem;font-weight:600;margin-bottom:1rem;}
  .price-label{font-size:.80rem;letter-spacing:.5px;color:#fff;opacity:.9;}
  .price-badge{
    background:#3f7f12;
    color:#fff;
    padding:.40rem .85rem;
    font-size:.85rem;
    border-radius:.45rem;
    line-height:1;
    display:inline-block;
    box-shadow:0 0 6px rgba(63,127,18,.55),0 0 0 1px rgba(255,255,255,.05) inset;
    animation:pricePulse 1.8s ease-in-out infinite;
  }
  @keyframes pricePulse{
    0%,100%{transform:translateY(0);box-shadow:0 0 6px rgba(63,127,18,.55),0 0 0 1px rgba(255,255,255,.05) inset;}
    50%{transform:translateY(-3px);box-shadow:0 0 14px rgba(63,127,18,.95),0 0 0 1px rgba(255,255,255,.08) inset;}
  }

  /* Badge COTA RECOMENDADA acima do bot√£o +10 */
  .cota-minima-wrap { position:relative; }
  .badge-cota-minima {
    position:absolute;
    top:-14px;
    left:50%;
    transform:translateX(-50%);
    background:#28a745;
    font-size:.65rem;
    letter-spacing:.5px;
    padding:4px 10px;
    border-radius:999px;
    font-weight:600;
    color:#fff;
    box-shadow:0 0 6px rgba(40,167,69,.6),0 0 0 1px rgba(255,255,255,.08) inset;
    animation:cotaBlink 1.1s ease-in-out infinite;
    text-transform:uppercase;
    white-space:nowrap;
  }
  @keyframes cotaBlink {
    0%,100% { opacity:1; filter:drop-shadow(0 0 4px rgba(40,167,69,.9)); transform:translate(-50%,0) scale(1); }
    50% { opacity:.25; filter:drop-shadow(0 0 8px rgba(40,167,69,1)); transform:translate(-50%,-4px) scale(1.08); }
  }
  @media (max-width:576px){
    .badge-cota-minima { top:-10px; font-size:.58rem; padding:3px 8px; }
  }
    @media (max-width:576px){
      #btn-minus,#btn-plus{padding:.55rem .9rem;font-size:1.05rem;}
      #btnAdquirir{font-size:1.05rem;padding:.85rem 1rem;}
    }
</style>
{% endblock %}

{% block content %}
<section class="sorteios-section d-flex justify-content-center align-items-start" data-rifa-id="{{ rifa.id }}">
  <div class="glass-login w-100">

  <!-- Removidas abas de navega√ß√£o para simplificar interface -->

    <!-- Imagem centralizada + badge posicionada -->
    <div class="text-center mb-3">
      {% if rifa.imagem %}
      <div class="raffle-img-box">
  <img src="{{ rifa.imagem.url }}" alt="{{ rifa.titulo }}" class="img-fluid rounded shadow" style="width:180px;height:180px;object-fit:cover;" loading="lazy" decoding="async">
        {% if not rifa.encerrada %}
          <span class="badge bg-success blink-badge badge-adquira">Adquira j√°!</span>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- T√≠tulo (sem "Adquira j√°!") -->
    <h3 class="text-center fw-bold mb-2 text-white">
      {{ rifa.titulo }}
      {% if rifa.encerrada %}
        <span class="badge bg-danger ms-2">Encerrada</span>
      {% endif %}
    </h3>

    <p class="text-muted text-center mb-3">{{ rifa.descricao }}</p>

    <!-- Substitu√≠do: bloco do pre√ßo com nova formata√ß√£o -->
    <div class="price-line">
      <span class="price-label">POR APENAS</span>
      <span class="price-badge">R$ {{ rifa.preco|floatformat:2 }}</span>
    </div>

    {% if rifa.encerrada and rifa.data_encerramento %}
      <div class="alert alert-warning text-center py-2 mb-3">
        Encerrada em: {{ rifa.data_encerramento|date:"d/m/Y H:i" }}
      </div>
    {% endif %}

    <!-- Cota√ß√£o -->
    <h5 class="text-center fw-bold mb-3 text-white">
      <i class="fas fa-bolt text-warning me-1"></i> Cotas
      <small class="text-muted">Escolha sua sorte</small>
    </h5>

    <!-- Quantidade de cotas -->
    <p class="text-center text-muted mb-2" style="font-size: 14px;">Selecione a quantidade de n√∫meros</p>

    <div class="row g-2 mb-3">
      {% for qtde in qtde_list %}
        <div class="col-6 col-md-4">
          {% if qtde|stringformat:"s" == '10' %}
          <div class="cota-minima-wrap text-center">
            <span class="badge-cota-minima badge">COTA RECOMENDADA</span>
            <div style="margin-top:6px;">
              <button class="btn btn-outline-secondary w-100 py-2" onclick="somarCotas({{ qtde }})">
                +{{ qtde }}<br><small>Selecionar</small>
              </button>
            </div>
          </div>
          {% else %}
          <button class="btn btn-outline-secondary w-100 py-2" onclick="somarCotas({{ qtde }})">
            +{{ qtde }}<br><small>Selecionar</small>
          </button>
          {% endif %}
        </div>
        {% endfor %}
    </div>

  <!-- √Årea de gerenciamento removida (agora apenas via modal na listagem) -->

    <div class="d-flex justify-content-center align-items-center mb-2" style="gap: 8px;">
      <button class="btn btn-outline-secondary btn-sm" id="btn-minus" type="button">‚àí</button>
      <input
        id="input-cotas"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        class="form-control text-center"
        aria-label="Quantidade de n√∫meros"
        style="width:70px;"
  value="1"
        autocomplete="off"
        data-preco="{{ rifa.preco|floatformat:2 }}"
        data-rifa-id="{{ rifa.id }}"
      >
      <button class="btn btn-outline-secondary btn-sm" id="btn-plus" type="button">+</button>
    </div>

    <div class="text-center mb-3" id="totalSelecionado" style="font-size:14px;font-weight:bold;color:#198754;">
      Total: R$ 0,00
    </div>

    <div id="alertMinCotas" class="alert alert-danger d-none mb-3 py-2" style="font-size:14px;"></div>

    {% if not rifa.encerrada %}
    <button id="btnAdquirir" class="btn btn-success w-100 mb-2 py-2" type="button">
      ‚úÖ Pagar ‚Äî <span id="valorAdquirir">R$ {{ rifa.preco|floatformat:2 }}</span>
    </button>
    {% endif %}

    <!-- Bot√£o "Ver meus n√∫meros" agora redireciona para a p√°gina Meus N√∫meros -->
    <a class="btn btn-outline-light fw-bold w-100 mb-3 d-flex align-items-center justify-content-center" href="{% url 'meus_numeros' %}">
      <i class="fas fa-shopping-cart me-2"></i> Ver meus n√∫meros
    </a>

    <!-- Se√ß√£o "N√∫meros dispon√≠veis" removida definitivamente -->
  </div>
  </div><!-- /glass-login -->
</section>

<section class="mt-5" id="premios-section">
  <div class="d-flex align-items-center mb-1">
    <h5 class="text-white fw-bold mb-0" style="letter-spacing:.5px;">
      <span class="me-2" style="filter:drop-shadow(0 0 4px #ffc107);">üéâ</span> Bilhetes Premiados, achou ganhou!
    </h5>
  </div>
  <p class="text-muted mb-3" style="margin-top:-2px;font-size:.85rem;">Achou ganhou!</p>
  <div id="premiosWrapper">
    <div id="premiosLoading" class="text-center text-muted small py-3 d-none">Carregando...</div>
    <div id="premiosEmpty" class="alert alert-secondary bg-transparent text-center text-muted py-3 mb-0 small d-none">Nenhum bilhete premiado definido ainda.</div>
    <div class="row g-3" id="grid-premios">
      {% if premios_list and premios_list|length > 0 %}
        {% for premio in premios_list %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3 d-flex">
          <div class="premio-card flex-fill">
            <div class="premio-head d-flex justify-content-between align-items-start">
              <div class="premio-valor">R$ {{ premio.valor_premio|floatformat:2 }}</div>
              {% if premio.ganho_por %}
                <span class="premio-status ganho">Ganho</span>
              {% else %}
                <span class="premio-status disponivel">‚óè Dispon√≠vel</span>
              {% endif %}
            </div>
            <div class="premio-numero">{{ premio.numero_premiado|stringformat:"06d" }}</div>
          </div>
        </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>

<style>
  #premios-section{max-width:1100px;margin:0 auto;}
  #grid-premios{margin-top:1.1rem;}
  .premio-card{background:#18191b;border:1px solid #202123;border-radius:18px;padding:1rem 1.15rem 1.15rem;position:relative;overflow:hidden;transition:.28s ease;box-shadow:0 4px 14px -6px rgba(0,0,0,.65);} 
  .premio-card:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 85% 15%,rgba(255,193,7,.12),transparent 70%);opacity:.8;pointer-events:none;} 
  .premio-card:hover{transform:translateY(-4px);box-shadow:0 8px 22px -10px rgba(0,0,0,.85),0 0 0 1px rgba(255,255,255,.06) inset;} 
  .premio-head{margin-bottom:.75rem;}
  .premio-valor{font-weight:700;color:#fff;font-size:1rem;line-height:1.1;}
  .premio-status{font-size:.72rem;font-weight:600;letter-spacing:.5px;padding:.35rem .75rem;border-radius:14px;white-space:nowrap;background:#222;margin-left:1rem;display:inline-flex;align-items:center;gap:.35rem;}
  .premio-status.disponivel{color:#1dd175;background:#15281e;border:1px solid #1c6c41;} 
  .premio-status.disponivel:before{content:'‚óè';font-size:.75rem;color:#1dd175;} 
  .premio-status.ganho{color:#111;background:#ffc107;border:1px solid #e0a800;} 
  .premio-status.ganho:before{content:'‚òÖ';font-size:.7rem;color:#111;}
  .premio-numero{display:inline-block;background:#d3d6da;color:#111;font-weight:700;letter-spacing:1px;font-size:.8rem;padding:.45rem .85rem;border-radius:8px;box-shadow:0 2px 4px -1px rgba(0,0,0,.45);} 
  @media (max-width:576px){.premio-card{padding:.95rem 1rem}.premio-valor{font-size:.95rem}.premio-status{font-size:.62rem;padding:.3rem .6rem}}
</style>

{% include 'rifa/modal_pagamento.html' %}
{% include 'rifa/modal_buscar_numeros.html' %}

<script>
(function() {
  const MIN_QTD = 1;

  const input      = document.getElementById('input-cotas');
  const minus      = document.getElementById('btn-minus');
  const plus       = document.getElementById('btn-plus');
  const spanTot    = document.getElementById('totalSelecionado');
  const spanBtn    = document.getElementById('valorAdquirir');
  const btnAdq     = document.getElementById('btnAdquirir');
  const alertMin   = document.getElementById('alertMinCotas');

  if (!input) return;

  const precoUnit = (function() {
    const raw = (input.dataset.preco || '0').replace(/\./g,'').replace(',', '.');
    const n = parseFloat(raw);
    return isNaN(n) ? 0 : n;
  })();

  // Obter ID da rifa do data attribute
  const rifaId = input.dataset.rifaId || document.querySelector('.sorteios-section')?.dataset?.rifaId;

  function formatBRL(v) {
    return (Number(v)||0).toLocaleString('pt-BR',{ style:'currency', currency:'BRL' });
  }

  function atualizar() {
    // mant√©m somente d√≠gitos
    let v = input.value.replace(/\D/g,'');
    input.value = v;
    let qtd = parseInt(v,10) || 0;

    // nunca permitir 0: for√ßa m√≠nimo
    if (qtd < MIN_QTD) {
      qtd = MIN_QTD;
      input.value = String(MIN_QTD);
    }

    const total = precoUnit * qtd;
    if (spanTot) spanTot.textContent = `Total: ${formatBRL(total)}`;
    if (spanBtn) spanBtn.textContent = formatBRL(total);

    if (minus) {
      if (qtd <= MIN_QTD) minus.setAttribute('disabled','disabled');
      else minus.removeAttribute('disabled');
    }

    // se usu√°rio aumentar depois de erro, limpar aviso
    if (alertMin && qtd >= MIN_QTD) {
      alertMin.classList.add('d-none');
      alertMin.textContent = '';
    }
  }

  // Eventos de digita√ß√£o/colagem
  ['input','change','paste','blur'].forEach(ev => {
    input.addEventListener(ev, atualizar);
  });

  // Bot√µes plus/minus
  if (plus) {
    plus.addEventListener('click', function() {
      let qtd = parseInt(input.value,10) || 0;
      input.value = (qtd + 1).toString();
      atualizar();
    });
  }

  if (minus) {
    minus.addEventListener('click', function() {
      let qtd = parseInt(input.value,10) || 0;
      if (qtd > MIN_QTD) {
        input.value = (qtd - 1).toString();
        atualizar();
      }
    });
  }

  // Bot√µes r√°pidos (+10, +20, etc.)
  window.somarCotas = function(qtde) {
    const add = parseInt(qtde,10) || 0;
    let qtd = parseInt(input.value,10) || 0;
    input.value = (qtd + add).toString();
    atualizar();
  };

  // Valida√ß√£o ao adquirir
  btnAdq?.addEventListener('click', (e) => {
    const qtd = parseInt(input.value,10) || 0;
    if (qtd < MIN_QTD) {
      e.preventDefault();
      if (alertMin) {
        const unidade = MIN_QTD === 1 ? 'bilhete' : 'bilhetes';
        alertMin.textContent = `A compra m√≠nima para este sorteio √© de ${MIN_QTD} ${unidade}.`;
        alertMin.classList.remove('d-none');
      }
      return;
    }
    
    // Calcular valor total
    const total = precoUnit * qtd;
    const valorFormatado = formatBRL(total);
    
    console.log('Abrindo modal de pagamento:', {
      valor: valorFormatado,
      quantidade: qtd,
      rifaId: rifaId,
      rifaIdType: typeof rifaId,
      precoUnit: precoUnit
    });
    
    // Garantir que rifaId seja uma string v√°lida
    const rifaIdString = rifaId ? String(rifaId) : null;
    
    // Chamar fun√ß√£o do modal com todos os par√¢metros necess√°rios
    if (typeof openPaymentModal === 'function') {
      openPaymentModal(valorFormatado, qtd, rifaIdString);
    } else {
      console.error('Fun√ß√£o openPaymentModal n√£o encontrada');
      alert('Erro: Modal de pagamento n√£o dispon√≠vel');
    }
  });

  // Inicial
  atualizar();
})();
</script>

<script>
// Atualiza√ß√£o din√¢mica dos Bilhetes Premiados
(function(){
  const rifaId = {{ rifa.id }};
  const grid = document.getElementById('grid-premios');
  const empty = document.getElementById('premiosEmpty');
  const loading = document.getElementById('premiosLoading');

  function formatValor(v){
    return (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  function renderPremios(lista){
    console.log('Renderizando premios', lista);
    grid.innerHTML='';
    if(!lista.length){
      empty.classList.remove('d-none');
      return;
    }
    empty.classList.add('d-none');
    const frag=document.createDocumentFragment();
    lista.forEach(p=>{
      const col=document.createElement('div');
      col.className='col-12 col-sm-6 col-lg-4';
      col.innerHTML=`<div class="premio-card h-100 p-3">
          <div class="premio-valor">${formatValor(p.valor)}</div>
          <div class="premio-numero badge">${String(p.numero).padStart(6,'0')}</div>
          <div class="premio-status ${p.ganho?'ganho':'disponivel'}">${p.ganho?'Ganho':'‚óè Dispon√≠vel'}</div>
        </div>`;
      frag.appendChild(col);
    });
    grid.appendChild(frag);
  }

  async function carregarPremiosPublico(){
    try{
      loading.classList.remove('d-none');
      const resp = await fetch(`/api/rifa/${rifaId}/premios/`);
      console.log('Resposta fetch status', resp.status);
      const data = await resp.json();
      console.log('Dados recebidos premios', data);
      if(data.premios){
        renderPremios(data.premios);
        if(!data.premios.length){
          empty.classList.remove('d-none');
        }
      }
    }catch(e){
      console.error('Falha ao carregar pr√™mios', e);
      // Se falhar e j√° havia conte√∫do inicial, mant√©m; sen√£o mostra vazio
      if(grid.children.length===0){
        empty.classList.remove('d-none');
      }
    }finally{
      loading.classList.add('d-none');
    }
  }

  // Expor para refresh manual ap√≥s adicionar no modal em outra p√°gina/aba
  window.atualizarPremiosRifa = carregarPremiosPublico;
  carregarPremiosPublico();
  // Polling leve a cada 25s para captar novos pr√™mios (pode ajustar ou remover)
  // Polling mais longo em mobile para economizar bateria
  const intervalo = window.matchMedia('(max-width: 576px)').matches ? 40000 : 25000;
  setInterval(carregarPremiosPublico, intervalo);
  // Listener de storage (caso outro tab atualize pr√™mios)
  window.addEventListener('storage', (e)=>{
    if(e.key === 'premios_updated_rifa_'+rifaId){
      carregarPremiosPublico();
    }
  });
})();
</script>
{% endblock %}