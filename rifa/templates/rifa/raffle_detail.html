{% extends 'rifa/base.html' %}
{% block title %}{{ rifa.titulo }} - Detalhes da Rifa{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 90vh; background: linear-gradient(135deg, #e8eaf6, #f5f5f7);">
  <div class="bg-white text-dark rounded-4 shadow p-4 animate__animated animate__fadeInUp" style="max-width: 480px; width: 100%;">

    {% if rifa.imagem %}
      <img src="{{ rifa.imagem.url }}" alt="{{ rifa.titulo }}" class="img-fluid rounded shadow mb-3 d-block mx-auto" style="width:180px; height:180px; object-fit:cover;">
    {% endif %}

    <h3 class="text-center fw-bold mb-2">{{ rifa.titulo }}
      {% if rifa.encerrada %}
        <span class="badge bg-danger ms-2">Encerrada</span>
      {% else %}
        <span class="badge bg-success ms-2">Ativa</span>
      {% endif %}
    </h3>

    <p class="text-muted text-center mb-3" style="font-size: 0.95rem;">{{ rifa.descricao }}</p>
    <div class="text-center mb-3">
      <span class="badge bg-dark px-3 py-2" style="font-size: 1rem;">R$ {{ rifa.preco|floatformat:2 }} por nÃºmero</span>
    </div>

    {% if rifa.encerrada and rifa.data_encerramento %}
      <div class="alert alert-warning text-center py-2 mb-3">Encerrada em: {{ rifa.data_encerramento|date:"d/m/Y H:i" }}</div>
    {% endif %}

    <h5 class="text-center fw-bold mb-2"><i class="fas fa-bolt text-warning me-1"></i> Cotas <small class="text-muted">Escolha sua sorte</small></h5>

    <button class="btn btn-light text-dark fw-bold w-100 mb-3" onclick="abrirModalNumeros()">
      <i class="fas fa-shopping-cart me-2"></i> Ver meus nÃºmeros
    </button>

    <p class="text-center text-muted mb-2" style="font-size: 14px;">Selecione a quantidade de nÃºmeros</p>

    <div class="row g-2 mb-3">
      {% for qtde in qtde_list %}
      <div class="col-6 col-md-4">
        <button class="btn btn-outline-secondary w-100 py-2" onclick="somarCotas({{ qtde }})">
          +{{ qtde }}<br><small>Selecionar</small>
          {% if qtde == '10' %}<span class="badge bg-success ms-1">Cota mÃ­nima</span>{% endif %}
        </button>
      </div>
      {% endfor %}
    </div>

    <div class="d-flex justify-content-center align-items-center mb-2" style="gap: 8px;">
      <button class="btn btn-outline-secondary btn-sm" id="btn-minus" type="button" style="width: 32px; height: 32px; font-size: 1.2rem;">âˆ’</button>
      <input id="input-cotas" class="form-control text-center" aria-label="Quantidade de nÃºmeros" readonly style="width: 60px; font-size: 1.1rem;" value="10">
      <button class="btn btn-outline-secondary btn-sm" id="btn-plus" type="button" style="width: 32px; height: 32px; font-size: 1.2rem;">+</button>
    </div>

    <div class="text-center mb-3" id="totalSelecionado" style="font-size: 14px; font-weight: bold; color: #198754;">
      Total selecionado
    </div>

    {% if not rifa.encerrada %}
      <button id="btnAdquirir" class="btn btn-success w-100 mb-3 py-2" onclick="abrirModalRifa()">
        âœ… Adquirir Bilhete â€” R$ {{ rifa.preco|floatformat:2 }}
      </button>
      {% if user.is_superuser or user.username == request.user.username %}
      <form method="post" action="{% url 'sortear_rifa' rifa.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning w-100 mb-3 py-2">
          <i class="fas fa-random me-2"></i>Sortear e Encerrar Rifa
        </button>
      </form>
      {% endif %}
    {% else %}
      <button class="btn btn-secondary w-100 mb-3 py-2" disabled>Bilhete IndisponÃ­vel</button>
    {% endif %}

    <div class="alert alert-secondary text-center mb-2" style="font-size: 14px;">ðŸŽ« NÃºmeros disponÃ­veis</div>
    <div style="max-height: 140px; overflow-y: auto;">
      {% for numero in numeros_list %}
      <div class="d-flex justify-content-between bg-light px-2 py-1 mb-1 rounded" style="font-size: 13px;">
        <span><i class="fas fa-ticket-alt me-1"></i> {{ numero }}</span>
        <span>R$ {{ rifa.valor }}</span>
        <span class="badge bg-success">DisponÃ­vel</span>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% include 'rifa/modal_abrir_rifa.html' %}
{% include 'rifa/modal_buscar_numeros.html' %}

<script>
function somarCotas(qtde) {
  const input = document.getElementById('input-cotas');
  input.value = parseInt(input.value) + qtde;
  atualizarTotal();
}

document.getElementById('btn-plus').addEventListener('click', () => {
  const input = document.getElementById('input-cotas');
  input.value = parseInt(input.value) + 1;
  atualizarTotal();
});

document.getElementById('btn-minus').addEventListener('click', () => {
  const input = document.getElementById('input-cotas');
  const valorAtual = parseInt(input.value);
  if (valorAtual > 1) {
    input.value = valorAtual - 1;
    atualizarTotal();
  }
});

function atualizarTotal() {
  const input = document.getElementById('input-cotas');
  const totalSpan = document.getElementById('totalSelecionado');
  const preco = parseFloat("{{ rifa.preco|floatformat:2 }}".replace(',', '.'));
  const total = preco * parseInt(input.value);
  totalSpan.innerText = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
}
</script>
{% endblock %}
