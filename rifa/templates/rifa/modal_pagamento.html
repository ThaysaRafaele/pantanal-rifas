<div class="payment-backdrop" id="paymentBackdrop" style="display:none;">
  <div class="payment-modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <button class="pay-close" type="button" aria-label="Fechar" onclick="closePaymentModal()">√ó</button>
    <h3 id="payTitle" class="pay-title">Finalize sua compra</h3>
    <p class="pay-total">Valor total: <span id="payValorTotal">R$ 0,00</span></p>

    <form id="payForm" onsubmit="return verificarCpf(event)">
      <!-- CPF -->
      <div class="mb-3">
        <label class="form-label small text-uppercase">CPF <span class="text-danger">(obrigat√≥rio)</span></label>
        <input type="text" maxlength="14" placeholder="000.000.000-00" class="form-control" id="payCpf" required>
        <div id="payCpfInvalid" class="text-danger small" style="display:none;margin-top:6px;">CPF inv√°lido.</div>
      </div>

      <!-- Dados do usu√°rio -->
      <div id="payUserBox" class="p-3 rounded mb-3" style="display:none;background:#222;border:1px solid #333;">
        <div class="d-flex align-items-center mb-2" style="gap:.6rem;">
          <i class="fas fa-user text-white-50"></i>
          <strong id="payUserNome" class="text-white small" style="font-size:1rem;">‚Äî</strong>
        </div>
        <div class="small text-muted" id="payUserEmail"></div>
        <div class="small text-muted" id="payUserTelefone"></div>
      </div>

      <!-- CPF n√£o encontrado -->
      <div id="payUserNotFound" class="alert alert-warning py-2 mb-3" style="display:none;font-size:.85rem;">
        N√£o existe conta cadastrada neste CPF. 
        <a href="/cadastro/" class="alert-link">Fa√ßa seu cadastro</a> para comprar n√∫meros.
      </div>

  <!-- A√ß√µes: Pagar + Usar outro cadastro (empilhados) -->
  <div id="payActions" class="modal-actions" style="display:none;margin-top:8px;gap:8px;flex-direction:column;align-items:center;">
        <button class="btn btn-success w-100 py-2" id="btnPagar" type="button" onclick="fazerPagamento()">Pagar</button>
        <button type="button" id="btnOutroCadastro" class="btn btn-link" style="text-decoration:underline;padding:0;margin-top:4px;" onclick="resetarCpfPagamento()">Usar outro cadastro</button>
      </div>
    </form>

    <!-- √Årea de QR Code -->
    <div id="modalQrArea" style="display:none;margin-top:16px;text-align:center;">
      <p id="modalQrStatus">Gerando QR Code...</p>
      <div id="modalQrImage" style="display:none;">
        <img id="modalQrImg" src="" alt="QR Code PIX" style="max-width:220px; height:auto; border:1px solid #ddd; background:#fff; padding:8px;" />
        <p style="margin-top:8px;"><a id="modalDownloadQr" href="#" download="qr.png">Baixar QR</a></p>
      </div>
      <pre id="modalQrRaw" style="display:none; word-break:break-all; white-space:pre-wrap; background:#111; color:#0f0; padding:8px; border-radius:6px;"></pre>
    </div>
  </div>
</div>

<script>
  // Dependemos do backend para verificar CPFs

  function verificarCpf(event) {
    event.preventDefault();
    const cpfRaw = document.getElementById('payCpf').value.trim();
    const cpf = cpfRaw.replace(/\D/g, '');
    const userBox = document.getElementById('payUserBox');
    const notFound = document.getElementById('payUserNotFound');
    const payActions = document.getElementById('payActions');
    const invalidMsg = document.getElementById('payCpfInvalid');

    // Resetar elementos
    userBox.style.display = 'none';
    notFound.style.display = 'none';
    if (payActions) payActions.style.display = 'none';
    if (invalidMsg) invalidMsg.style.display = 'none';

    // Valida CPF localmente
    if (!isValidCPF(cpf)) {
      if (invalidMsg) invalidMsg.style.display = 'block';
      return false;
    }

    // Chama API backend para verificar o CPF
    fetch('/api/verificar-cpf/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cpf: cpf })
    }).then(r => r.json()).then(data => {
      if (data && data.found) {
        const u = data.user || {};
        document.getElementById('payUserNome').textContent = u.nome || '‚Äî';
        document.getElementById('payUserEmail').textContent = u.email || '';
        document.getElementById('payUserTelefone').textContent = u.telefone || '';
        userBox.style.display = 'block';
        if (payActions) payActions.style.display = 'flex';
      } else {
        notFound.style.display = 'block';
        if (payActions) payActions.style.display = 'none';
      }
    }).catch(err => {
      console.error('Erro verificando CPF', err);
      notFound.style.display = 'block';
      if (payActions) payActions.style.display = 'none';
    });
  }

  // Valida√ß√£o de CPF (recebe apenas d√≠gitos, sem formata√ß√£o)
  function isValidCPF(digits) {
    if (!digits || digits.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(digits)) return false; // todos iguais
    const nums = digits.split('').map(d => parseInt(d, 10));

    let sum = 0;
    for (let i = 0; i < 9; i++) sum += nums[i] * (10 - i);
    let rev = (sum * 10) % 11;
    if (rev === 10) rev = 0;
    if (rev !== nums[9]) return false;

    sum = 0;
    for (let i = 0; i < 10; i++) sum += nums[i] * (11 - i);
    rev = (sum * 10) % 11;
    if (rev === 10) rev = 0;
    if (rev !== nums[10]) return false;

    return true;
  }

  function fazerPagamento() {
    alert("üîó Integre aqui a API do Mercado Pago para gerar o pagamento PIX.");
    // Aqui voc√™ vai implementar a chamada real para sua API
  }

  function resetarCpfPagamento() {
    document.getElementById('payCpf').value = '';
  document.getElementById('payUserBox').style.display = 'none';
  if(document.getElementById('payActions')) document.getElementById('payActions').style.display = 'none';
    document.getElementById('payUserNotFound').style.display = 'none';
  }
</script>
