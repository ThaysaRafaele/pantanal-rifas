<div class="payment-backdrop" id="paymentBackdrop" style="display:none;">
  <div class="payment-modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <button class="pay-close" type="button" aria-label="Fechar" onclick="closePaymentModal()">×</button>
    
    <!-- Etapa 1: Verificação de CPF -->
    <div id="stepCpfVerification">
      <h3 id="payTitle" class="pay-title">💳 Finalize sua compra</h3>
      <p class="pay-total">Valor total: <span id="payValorTotal">R$ 0,00</span></p>

      <form id="payForm" onsubmit="return verificarCpf(event)">
        <!-- CPF -->
        <div class="mb-3">
          <label class="form-label small text-uppercase">
            <i class="fas fa-id-card me-2"></i>CPF <span class="text-danger">(obrigatório)</span>
          </label>
          <input type="text" maxlength="14" placeholder="000.000.000-00" class="form-control" id="payCpf" required>
          <div id="payCpfInvalid" class="text-danger small" style="display:none;margin-top:6px;">CPF inválido.</div>
        </div>

        <!-- Dados do usuário -->
        <div id="payUserBox" class="user-info-box" style="display:none;">
          <h6><i class="fas fa-user me-2"></i>Dados do Comprador</h6>
          <div class="user-info-item">
            <i class="fas fa-user"></i>
            <strong id="payUserNome">—</strong>
          </div>
          <div class="user-info-item">
            <i class="fas fa-envelope"></i>
            <span id="payUserEmail">—</span>
          </div>
          <div class="user-info-item">
            <i class="fas fa-phone"></i>
            <span id="payUserTelefone">—</span>
          </div>
        </div>

        <!-- CPF não encontrado -->
        <div id="payUserNotFound" class="alert alert-warning" style="display:none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Não existe conta cadastrada com este CPF. 
          <a href="/cadastro/" class="alert-link fw-bold">Faça seu cadastro aqui</a>
        </div>

        <!-- Ações  -->
        <div id="payActions" style="display:none;margin-top:20px;">
          <button class="btn btn-success w-100 mb-3" id="btnPagar" type="button" onclick="processarPagamento()">
            <i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento
          </button>
          <button type="button" id="btnOutroCadastro" class="btn btn-link w-100" onclick="resetarCpfPagamento()">
            <i class="fas fa-undo me-2"></i>Usar outro CPF
          </button>
        </div>
      </form>
    </div>

    <!-- Etapa 2: QR Code e Processamento -->
    <div id="stepPaymentProcessing" style="display:none;">
      <h3 class="pay-title text-success">
        <i class="fas fa-check-circle me-2"></i>Pedido Criado!
      </h3>
      <p class="text-center text-muted mb-4">Seus números foram reservados</p>

      <!-- Status do pagamento -->
      <div id="paymentStatus" class="text-center mb-3">
        <span id="statusText">Gerando PIX...</span>
        <span id="statusBadge" class="status-badge status-pending">Pendente</span>
      </div>

      <!-- Área do QR Code -->
      <div id="modalQrArea" class="qr-code-area">
        <h6 class="text-warning mb-3">
          <i class="fas fa-qrcode me-2"></i>Escaneie o QR Code ou copie a chave PIX
        </h6>
        
        <!-- QR Code Imagem -->
        <div id="modalQrImage" style="display:none;">
          <img id="modalQrImg" src="" alt="QR Code PIX" class="qr-code-image">
          <div class="mt-3">
            <button class="copy-button" onclick="downloadQR()">
              <i class="fas fa-download me-2"></i>Baixar QR
            </button>
          </div>
        </div>

        <!-- PIX Texto -->
        <div id="pixCodeContainer" style="display:none;">
          <h6 class="text-info mb-2">Chave PIX:</h6>
          <div class="pix-code-text" id="modalQrRaw"></div>
          <button class="copy-button" onclick="copyPixCode()">
            <i class="fas fa-copy me-2"></i>Copiar Chave PIX
          </button>
        </div>

        <!-- Loading -->
        <div id="qrLoading" class="text-center">
          <div class="loading-spinner me-2"></div>
          <span id="modalQrStatus">Gerando QR Code PIX...</span>
        </div>

        <!-- Instruções -->
        <div class="payment-instructions">
          <h6><i class="fas fa-info-circle me-2"></i>Como pagar:</h6>
          <ul>
            <li>Abra o app do seu banco</li>
            <li>Escolha a opção PIX</li>
            <li>Escaneie o QR Code ou cole a chave PIX</li>
            <li>Confirme o pagamento</li>
            <li>Guarde o comprovante</li>
          </ul>
        </div>
      </div>

      <!-- Botões de ação -->
      <div class="mt-4 text-center">
        <button class="btn btn-outline-light" onclick="closePaymentModal()">
          <i class="fas fa-times me-2"></i>Fechar
        </button>
        <button class="btn btn-info ms-2" onclick="checkPaymentStatus()" id="btnCheckStatus" style="display:none;">
          <i class="fas fa-refresh me-2"></i>Verificar Pagamento
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .payment-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .payment-modal {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #ffd700;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    color: #fff;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    position: relative;
  }

  .pay-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    color: #ffd700;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .pay-close:hover {
    background: rgba(255, 215, 0, 0.1);
    transform: rotate(90deg);
  }

  .pay-title {
    color: #ffd700;
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 10px;
    text-align: center;
  }

  .pay-total {
    text-align: center;
    font-size: 1.3rem;
    color: #28a745;
    font-weight: bold;
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 10px;
  }

  .form-control {
    background-color: #333;
    border: 2px solid #555;
    color: #fff;
    border-radius: 8px;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    background-color: #444;
    border-color: #ffd700;
    box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
    color: #fff;
  }

  .form-label {
    color: #ffd700;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .user-info-box {
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .user-info-box h6 {
    color: #ffd700;
    margin-bottom: 15px;
    font-size: 1.1rem;
  }

  .user-info-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    color: #fff;
  }

  .user-info-item i {
    color: #ffd700;
    width: 20px;
    margin-right: 10px;
  }

  .btn-success {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    border-radius: 10px;
    padding: 15px 30px;
    font-weight: bold;
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: linear-gradient(45deg, #218838, #1ea589);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
  }

  .btn-link {
    color: #ffd700 !important;
    text-decoration: none;
    font-weight: 600;
    background: none !important;
    border: none !important;
  }

  .btn-link:hover {
    color: #ffed4e !important;
    text-decoration: underline;
  }

  .qr-code-area {
    text-align: center;
    margin: 20px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    border: 1px solid rgba(255, 215, 0, 0.2);
  }

  .qr-code-image {
    max-width: 250px;
    width: 100%;
    height: auto;
    border: 3px solid #ffd700;
    border-radius: 10px;
    background: #fff;
    padding: 10px;
    margin-bottom: 15px;
  }

  .pix-code-text {
    background: #222;
    color: #0f0;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    word-break: break-all;
    white-space: pre-wrap;
    margin: 15px 0;
    border: 1px solid #333;
  }

  .copy-button {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
    font-weight: bold;
  }

  .copy-button:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
    transform: translateY(-1px);
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 215, 0, 0.3);
    border-radius: 50%;
    border-top-color: #ffd700;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    margin-left: 10px;
  }

  .status-pending {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid #ffc107;
  }

  .status-approved {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid #28a745;
  }

  .payment-instructions {
    background: rgba(0, 123, 255, 0.1);
    border: 1px solid rgba(0, 123, 255, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
  }

  .payment-instructions h6 {
    color: #007bff;
    margin-bottom: 10px;
  }

  .payment-instructions ul {
    margin: 0;
    padding-left: 20px;
  }

  .payment-instructions li {
    margin-bottom: 5px;
    color: #ccc;
  }

  /* DEBUG: Forçar visibilidade das ações */
  #payActions {
    display: block !important;
    margin-top: 20px;
    padding: 15px;
    background: rgba(0, 255, 0, 0.05);
    border: 1px solid rgba(0, 255, 0, 0.2);
    border-radius: 10px;
  }

  #payActions.hidden {
    display: none !important;
  }

  @media (max-width: 576px) {
    .payment-modal {
      margin: 10px;
      padding: 20px;
    }

    .pay-title {
      font-size: 1.5rem;
    }

    .qr-code-image {
      max-width: 200px;
    }
  }
</style>

<script>
  let currentPedidoId = null;
  let currentQuantidade = 1;
  let currentRifaId = null;
  let paymentCheckInterval = null;

  // abrir modal
  function openPaymentModal(valorTotal, quantidade = 1, rifaId = null) {
    console.log('Abrindo modal:', { valorTotal, quantidade, rifaId });
    document.getElementById('payValorTotal').textContent = valorTotal;
    currentQuantidade = quantidade;
    currentRifaId = rifaId;
    
    // Reset do modal
    resetModal();
    
    document.getElementById('paymentBackdrop').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // Fechar modal
  function closePaymentModal() {
    document.getElementById('paymentBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    if (paymentCheckInterval) {
      clearInterval(paymentCheckInterval);
      paymentCheckInterval = null;
    }
  }

  // Reset completo do modal
  function resetModal() {
    console.log('Resetando modal');
    // Mostrar etapa 1, esconder etapa 2
    document.getElementById('stepCpfVerification').style.display = 'block';
    document.getElementById('stepPaymentProcessing').style.display = 'none';
    
    // Limpar dados
    document.getElementById('payCpf').value = '';
    document.getElementById('payUserBox').style.display = 'none';
    document.getElementById('payUserNotFound').style.display = 'none';
    
    const payActions = document.getElementById('payActions');
    payActions.style.display = 'none';
    payActions.className = 'hidden';
    
    document.getElementById('payCpfInvalid').style.display = 'none';
    
    currentPedidoId = null;
  }

  // Verificar CPF
  function verificarCpf(event) {
    event.preventDefault();
    console.log('Verificando CPF...');
    
    const cpfRaw = document.getElementById('payCpf').value.trim();
    const cpf = cpfRaw.replace(/\D/g, '');
    
    console.log('CPF digitado:', cpfRaw, 'CPF limpo:', cpf);
    
    // Resetar elementos
    document.getElementById('payUserBox').style.display = 'none';
    document.getElementById('payUserNotFound').style.display = 'none';
    
    const payActions = document.getElementById('payActions');
    payActions.style.display = 'none';
    payActions.className = 'hidden';
    
    document.getElementById('payCpfInvalid').style.display = 'none';

    // Validar CPF
    if (!isValidCPF(cpf)) {
      console.log('CPF inválido');
      document.getElementById('payCpfInvalid').style.display = 'block';
      return false;
    }

    console.log('CPF válido, consultando backend...');

    // Verificar CPF no backend
    fetch('/api/verificar-cpf/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ cpf: cpf })
    })
    .then(r => r.json())
    .then(data => {
      console.log('Resposta do backend:', data);
      
      if (data && data.found) {
        const u = data.user || {};
        document.getElementById('payUserNome').textContent = u.nome || '—';
        document.getElementById('payUserEmail').textContent = u.email || '—';
        document.getElementById('payUserTelefone').textContent = u.telefone || '—';
        
        // Mostrar dados do usuário
        document.getElementById('payUserBox').style.display = 'block';
        
        // Mostrar ações
        console.log('Mostrando botões de ação...');
        payActions.style.display = 'block';
        payActions.className = '';
        
        // Debug: forçar visibilidade
        setTimeout(() => {
          console.log('Estado final do payActions:', {
            display: payActions.style.display,
            className: payActions.className,
            visible: payActions.offsetHeight > 0
          });
        }, 100);
        
      } else {
        console.log('CPF não encontrado');
        document.getElementById('payUserNotFound').style.display = 'block';
      }
    })
    .catch(err => {
      console.error('Erro verificando CPF', err);
      document.getElementById('payUserNotFound').style.display = 'block';
    });

    return false;
  }

  // Processar pagamento
  function processarPagamento() {
    console.log('Processando pagamento...');
    
    if (!currentRifaId) {
      alert('Erro: ID da rifa não encontrado');
      return;
    }

    const cpf = document.getElementById('payCpf').value.replace(/\D/g, '');
    const btnPagar = document.getElementById('btnPagar');
    
    btnPagar.disabled = true;
    btnPagar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

    // Criar pedido
    const formData = new FormData();
    formData.append('rifa_id', currentRifaId);
    formData.append('cpf', cpf);
    formData.append('quantidade', currentQuantidade);

    fetch('/api/criar-pedido/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      console.log('Resposta criar pedido:', data);
      
      if (data.success) {
        currentPedidoId = data.pedido_id;
        
        // Mostrar prêmios ganhos se houver
        if (data.premios_ganhos && data.premios_ganhos.length > 0) {
          let premiosMsg = 'Parabéns! Você ganhou prêmios:\n';
          data.premios_ganhos.forEach(p => {
            premiosMsg += `🎉 Número ${p.numero}: R$ ${p.valor.toFixed(2)}\n`;
          });
          alert(premiosMsg);
        }
        
        // Trocar para etapa 2
        document.getElementById('stepCpfVerification').style.display = 'none';
        document.getElementById('stepPaymentProcessing').style.display = 'block';
        
        // Gerar QR Code
        gerarQRCode();
      } else {
        alert(data.error || 'Erro ao criar pedido');
        btnPagar.disabled = false;
        btnPagar.innerHTML = '<i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento';
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao processar pagamento');
      btnPagar.disabled = false;
      btnPagar.innerHTML = '<i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento';
    });
  }

  //Gerar QR Code
  function gerarQRCode() {
    console.log('Gerando QR Code para pedido:', currentPedidoId);
    
    if (!currentPedidoId) return;

    fetch('/api/gerar-qr/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        pedido_id: currentPedidoId
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Resposta gerar QR:', data);
      
      document.getElementById('qrLoading').style.display = 'none';
      
      if (data.success) {
        // Mostrar QR Code
        if (data.qr_code_base64) {
          const img = document.getElementById('modalQrImg');
          img.src = `data:image/png;base64,${data.qr_code_base64}`;
          document.getElementById('modalQrImage').style.display = 'block';
        }
        
        // Mostrar código PIX
        if (data.qr_code) {
          document.getElementById('modalQrRaw').textContent = data.qr_code;
          document.getElementById('pixCodeContainer').style.display = 'block';
        }
        
        // verificação automática
        document.getElementById('btnCheckStatus').style.display = 'inline-block';
        startPaymentCheck();
        
      } else {
        alert(data.error || 'Erro ao gerar QR Code');
      }
    })
    .catch(error => {
      console.error('Erro ao gerar QR:', error);
      document.getElementById('qrLoading').style.display = 'none';
      alert('Erro ao gerar QR Code');
    });
  }

  // Verificar status do pagamento
  function checkPaymentStatus() {
    if (!currentPedidoId) return;

    fetch(`/api/pedido/${currentPedidoId}/status/`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.status === 'pago') {
        alert('Pagamento confirmado! Recarregando página...');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }
    })
    .catch(error => {
      console.error('Erro ao verificar pagamento:', error);
    });
  }

  // verificação automática do pagamento
  function startPaymentCheck() {
    if (paymentCheckInterval) {
      clearInterval(paymentCheckInterval);
    }
    
    paymentCheckInterval = setInterval(() => {
      checkPaymentStatus();
    }, 10000); 
  }

  // Copiar código PIX
  function copyPixCode() {
    const pixCode = document.getElementById('modalQrRaw').textContent;
    navigator.clipboard.writeText(pixCode).then(() => {
      alert('Código PIX copiado!');
    }).catch(err => {
      console.error('Erro ao copiar:', err);
    });
  }

  // Download do QR Code
  function downloadQR() {
    const img = document.getElementById('modalQrImg');
    const link = document.createElement('a');
    link.download = 'qrcode-pix.png';
    link.href = img.src;
    link.click();
  }

  function resetarCpfPagamento() {
    console.log('Resetando CPF...');
    document.getElementById('payCpf').value = '';
    document.getElementById('payUserBox').style.display = 'none';
    
    const payActions = document.getElementById('payActions');
    payActions.style.display = 'none';
    payActions.className = 'hidden';
    
    document.getElementById('payUserNotFound').style.display = 'none';
    document.getElementById('payCpfInvalid').style.display = 'none';
    
    document.getElementById('payCpf').focus();
  }

  // Validação de CPF 
  function isValidCPF(digits) {
    if (!digits || digits.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(digits)) return false;
    
    const nums = digits.split('').map(d => parseInt(d, 10));

    let sum = 0;
    for (let i = 0; i < 9; i++) sum += nums[i] * (10 - i);
    let rev = (sum * 10) % 11;
    if (rev === 10) rev = 0;
    if (rev !== nums[9]) return false;

    sum = 0;
    for (let i = 0; i < 10; i++) sum += nums[i] * (11 - i);
    rev = (sum * 10) % 11;
    if (rev === 10) rev = 0;
    if (rev !== nums[10]) return false;

    return true;
  }

  // Obter CSRF Token
  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  // Máscara para CPF
  document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('payCpf');
    if (cpfInput) {
      cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
      });
    }
  });

  window.openPaymentModal = openPaymentModal;
  window.closePaymentModal = closePaymentModal;

  function fazerPagamento() {
    processarPagamento();
  }
</script>