<!-- CAMPOS HIDDEN PARA DADOS DO PEDIDO -->
<input type="hidden" id="hiddenRifaId" value="">
<input type="hidden" id="hiddenQuantidade" value="">
<input type="hidden" id="hiddenValorTotal" value="">
<input type="hidden" id="hiddenPedidoId" value="">

<div class="payment-backdrop" id="paymentBackdrop" style="display:none;">
  <div class="payment-modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <button class="pay-close" type="button" aria-label="Fechar" onclick="closePaymentModal()">√ó</button>
    
    <!-- Etapa 1: Verifica√ß√£o de CPF -->
    <div id="stepCpfVerification">
      <h3 id="payTitle" class="pay-title">üí≥ Finalize sua compra</h3>
      <p class="pay-total">Valor total: <span id="payValorTotal">R$ 0,00</span></p>
      <p class="pay-quantity">Quantidade: <span id="payQuantidade">1</span> n√∫mero(s)</p>

      <form id="payForm" onsubmit="return verificarCpf(event)">
        <!-- CPF -->
        <div class="mb-3">
          <label class="form-label small text-uppercase">
            <i class="fas fa-id-card me-2"></i>CPF <span class="text-danger">(obrigat√≥rio)</span>
          </label>
          <input type="text" maxlength="14" placeholder="000.000.000-00" class="form-control" id="payCpf" required>
          <div id="payCpfInvalid" class="text-danger small" style="display:none;margin-top:6px;">CPF inv√°lido.</div>
        </div>

        <!-- Dados do usu√°rio -->
        <div id="payUserBox" class="user-info-box" style="display:none;">
          <h6><i class="fas fa-user me-2"></i>Dados do Comprador</h6>
          <div class="user-info-item">
            <i class="fas fa-user"></i>
            <strong id="payUserNome">‚Äî</strong>
          </div>
          <div class="user-info-item">
            <i class="fas fa-envelope"></i>
            <span id="payUserEmail">‚Äî</span>
          </div>
          <div class="user-info-item">
            <i class="fas fa-phone"></i>
            <span id="payUserTelefone">‚Äî</span>
          </div>
        </div>

        <!-- CPF n√£o encontrado -->
        <div id="payUserNotFound" class="alert alert-warning" style="display:none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          N√£o existe conta cadastrada com este CPF. 
          <a href="/cadastro/" class="alert-link fw-bold">Fa√ßa seu cadastro aqui</a>
        </div>

        <!-- A√ß√µes -->
        <div id="payActions" style="display:none;margin-top:20px;">
          <button class="btn btn-success w-100 mb-3" id="btnPagar" type="button" onclick="processarPagamento()">
            <i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento
          </button>
          <button type="button" id="btnOutroCadastro" class="btn btn-link w-100" onclick="resetarCpfPagamento()">
            <i class="fas fa-undo me-2"></i>Usar outro CPF
          </button>
        </div>
      </form>
    </div>

    <!-- Etapa 2: QR Code e Processamento -->
    <div id="stepPaymentProcessing" style="display:none;">
      <h3 class="pay-title text-success">
        <i class="fas fa-check-circle me-2"></i>Pedido Criado!
      </h3>
      <p class="text-center text-muted mb-4">Seus n√∫meros foram reservados</p>

      <!-- √Årea do QR Code -->
      <div id="modalQrArea" class="qr-code-area">
        <h6 class="text-warning mb-3">
          <i class="fas fa-qrcode me-2"></i>Escaneie o QR Code ou copie a chave PIX
        </h6>
        
        <!-- QR Code Imagem -->
        <div id="modalQrImage" style="display:none;">
          <img id="modalQrImg" src="" alt="QR Code PIX" class="qr-code-image">
          <div class="mt-3">
            <button class="copy-button" onclick="downloadQR()">
              <i class="fas fa-download me-2"></i>Baixar QR
            </button>
          </div>
        </div>

        <!-- PIX Texto -->
        <div id="pixCodeContainer" style="display:none;">
          <h6 class="text-info mb-2">Chave PIX:</h6>
          <div class="pix-code-text" id="modalQrRaw"></div>
          <button class="copy-button" onclick="copyPixCode()">
            <i class="fas fa-copy me-2"></i>Copiar Chave PIX
          </button>
        </div>

        <!-- Loading -->
        <div id="qrLoading" class="text-center">
          <div class="loading-spinner me-2"></div>
          <span id="modalQrStatus">Gerando QR Code PIX...</span>
        </div>

        <!-- Instru√ß√µes -->
        <div class="payment-instructions">
          <h6><i class="fas fa-info-circle me-2"></i>Como pagar:</h6>
          <ul>
            <li>Abra o app do seu banco</li>
            <li>Escolha a op√ß√£o PIX</li>
            <li>Escaneie o QR Code ou cole a chave PIX</li>
            <li>Confirme o pagamento</li>
            <li>Guarde o comprovante</li>
          </ul>
        </div>
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div class="mt-4 text-center">
        <button class="btn btn-outline-light" onclick="closePaymentModal()">
          <i class="fas fa-times me-2"></i>Fechar
        </button>
        <button class="btn btn-info ms-2" onclick="checkPaymentStatus()" id="btnCheckStatus" style="display:none;">
          <i class="fas fa-refresh me-2"></i>Verificar Pagamento
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .payment-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .payment-modal {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #ffd700;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    color: #fff;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    position: relative;
  }

  .pay-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    color: #ffd700;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .pay-close:hover {
    background: rgba(255, 215, 0, 0.1);
    transform: rotate(90deg);
  }

  .pay-title {
    color: #ffd700;
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 10px;
    text-align: center;
  }

  .pay-total {
    text-align: center;
    font-size: 1.3rem;
    color: #28a745;
    font-weight: bold;
    margin-bottom: 10px;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 10px;
  }

  .pay-quantity {
    text-align: center;
    font-size: 1.1rem;
    color: #ffd700;
    font-weight: bold;
    margin-bottom: 25px;
    padding: 10px;
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
  }

  .form-control {
    background-color: #333;
    border: 2px solid #555;
    color: #fff;
    border-radius: 8px;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    background-color: #444;
    border-color: #ffd700;
    box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
    color: #fff;
  }

  .form-label {
    color: #ffd700;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .user-info-box {
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .user-info-box h6 {
    color: #ffd700;
    margin-bottom: 15px;
    font-size: 1.1rem;
  }

  .user-info-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    color: #fff;
  }

  .user-info-item i {
    color: #ffd700;
    width: 20px;
    margin-right: 10px;
  }

  .btn-success {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    border-radius: 10px;
    padding: 15px 30px;
    font-weight: bold;
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }

  .btn-success:hover {
    background: linear-gradient(45deg, #218838, #1ea589);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
  }

  .btn-link {
    color: #ffd700 !important;
    text-decoration: none;
    font-weight: 600;
    background: none !important;
    border: none !important;
  }

  .btn-link:hover {
    color: #ffed4e !important;
    text-decoration: underline;
  }

  .qr-code-area {
    text-align: center;
    margin: 20px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    border: 1px solid rgba(255, 215, 0, 0.2);
  }

  .qr-code-image {
    max-width: 250px;
    width: 100%;
    height: auto;
    border: 3px solid #ffd700;
    border-radius: 10px;
    background: #fff;
    padding: 10px;
    margin-bottom: 15px;
  }

  .pix-code-text {
    background: #222;
    color: #0f0;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    word-break: break-all;
    white-space: pre-wrap;
    margin: 15px 0;
    border: 1px solid #333;
  }

  .copy-button {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
    font-weight: bold;
  }

  .copy-button:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
    transform: translateY(-1px);
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 215, 0, 0.3);
    border-radius: 50%;
    border-top-color: #ffd700;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .payment-instructions {
    background: rgba(0, 123, 255, 0.1);
    border: 1px solid rgba(0, 123, 255, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
  }

  .payment-instructions h6 {
    color: #007bff;
    margin-bottom: 10px;
  }

  .payment-instructions ul {
    margin: 0;
    padding-left: 20px;
  }

  .payment-instructions li {
    margin-bottom: 5px;
    color: #ccc;
  }

  #payActions {
    display: block !important;
    margin-top: 20px;
    padding: 15px;
    background: rgba(0, 255, 0, 0.05);
    border: 1px solid rgba(0, 255, 0, 0.2);
    border-radius: 10px;
  }

  @media (max-width: 576px) {
    .payment-modal {
      margin: 10px;
      padding: 20px;
    }

    .pay-title {
      font-size: 1.5rem;
    }

    .qr-code-image {
      max-width: 200px;
    }
  }
</style>

<script>
// Vari√°veis globais para armazenar dados do pedido
var currentPedidoId = null;
var currentQuantidade = 1;
var currentRifaId = null;
var currentValorTotal = 0;
var paymentCheckInterval = null;

// FUN√á√ÉO PRINCIPAL - aceita pedidoId opcional
function openPaymentModal(valorTotal, quantidade, rifaId, pedidoId) {
  console.log('Abrindo modal - Pedido:', pedidoId || 'novo', 'Rifa:', rifaId, 'Qtd:', quantidade);
  
  // Validar par√¢metros obrigat√≥rios
  if (!rifaId) {
    console.error('Erro: rifaId n√£o fornecido');
    alert('Erro: ID da rifa n√£o encontrado. Recarregue a p√°gina.');
    return;
  }
  
  if (!quantidade || quantidade < 1) {
    console.error('Erro: quantidade inv√°lida');
    alert('Erro: Quantidade inv√°lida.');
    return;
  }
  
  // Armazenar dados globalmente
  currentRifaId = String(rifaId);
  currentQuantidade = parseInt(quantidade, 10);
  currentValorTotal = parseFloat(valorTotal.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
  
  // SE PEDIDO J√Å EXISTE (vindo de meus_numeros), pular para etapa de pagamento
  if (pedidoId) {
    currentPedidoId = pedidoId;
    document.getElementById('hiddenPedidoId').value = currentPedidoId;
    
    // Atualizar interface
    document.getElementById('payValorTotal').textContent = valorTotal;
    document.getElementById('payQuantidade').textContent = currentQuantidade;
    
    // Pular direto para etapa 2
    document.getElementById('stepCpfVerification').style.display = 'none';
    document.getElementById('stepPaymentProcessing').style.display = 'block';
    
    // Gerar QR Code imediatamente
    gerarQRCode();
    
  } else {
    // Pedido novo - seguir fluxo normal
    currentPedidoId = null;
    
    // Salvar nos campos hidden
    document.getElementById('hiddenRifaId').value = currentRifaId;
    document.getElementById('hiddenQuantidade').value = currentQuantidade;
    document.getElementById('hiddenValorTotal').value = currentValorTotal;
    
    // Atualizar interface do modal
    document.getElementById('payValorTotal').textContent = valorTotal;
    document.getElementById('payQuantidade').textContent = currentQuantidade;
    
    // Reset e mostrar etapa 1
    resetModal();
  }
  
  // Mostrar modal
  document.getElementById('paymentBackdrop').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // Focar no campo CPF se for novo pedido
  if (!pedidoId) {
    setTimeout(function() {
      var cpfField = document.getElementById('payCpf');
      if (cpfField) cpfField.focus();
    }, 100);
  }
}

// Fechar modal
function closePaymentModal() {
  document.getElementById('paymentBackdrop').style.display = 'none';
  document.body.style.overflow = 'auto';
  
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
    paymentCheckInterval = null;
  }
}

// Reset completo do modal
function resetModal() {
  document.getElementById('stepCpfVerification').style.display = 'block';
  document.getElementById('stepPaymentProcessing').style.display = 'none';
  
  document.getElementById('payCpf').value = '';
  document.getElementById('payUserBox').style.display = 'none';
  document.getElementById('payUserNotFound').style.display = 'none';
  document.getElementById('payActions').style.display = 'none';
  document.getElementById('payCpfInvalid').style.display = 'none';
  
  document.getElementById('qrLoading').style.display = 'block';
  document.getElementById('modalQrImage').style.display = 'none';
  document.getElementById('pixCodeContainer').style.display = 'none';
  document.getElementById('btnCheckStatus').style.display = 'none';
}

// Verificar CPF
function verificarCpf(event) {
  event.preventDefault();
  
  var cpfRaw = document.getElementById('payCpf').value.trim();
  var cpf = cpfRaw.replace(/\D/g, '');
  
  document.getElementById('payUserBox').style.display = 'none';
  document.getElementById('payUserNotFound').style.display = 'none';
  document.getElementById('payActions').style.display = 'none';
  document.getElementById('payCpfInvalid').style.display = 'none';

  if (!isValidCPF(cpf)) {
    document.getElementById('payCpfInvalid').style.display = 'block';
    return false;
  }

  fetch('/api/verificar-cpf/', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify({ cpf: cpf })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data && data.found) {
      var u = data.user || {};
      document.getElementById('payUserNome').textContent = u.nome || '‚Äî';
      document.getElementById('payUserEmail').textContent = u.email || '‚Äî';
      document.getElementById('payUserTelefone').textContent = u.telefone || '‚Äî';
      
      document.getElementById('payUserBox').style.display = 'block';
      document.getElementById('payActions').style.display = 'block';
      
    } else {
      console.log('CPF n√£o encontrado');
      document.getElementById('payUserNotFound').style.display = 'block';
    }
  })
  .catch(function(err) {
    console.error('Erro verificando CPF', err);
    document.getElementById('payUserNotFound').style.display = 'block';
  });

  return false;
}

// Processar pagamento
function processarPagamento() {
  if (!currentRifaId) {
    console.error('currentRifaId n√£o definido');
    alert('Erro: ID da rifa n√£o encontrado. Recarregue a p√°gina.');
    return;
  }
  
  if (!currentQuantidade || currentQuantidade < 1) {
    console.error('currentQuantidade inv√°lida');
    alert('Erro: Quantidade inv√°lida.');
    return;
  }

  var cpf = document.getElementById('payCpf').value.replace(/\D/g, '');
  var btnPagar = document.getElementById('btnPagar');
  
  btnPagar.disabled = true;
  btnPagar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

  var formData = new FormData();
  formData.append('rifa_id', currentRifaId);
  formData.append('cpf', cpf);
  formData.append('quantidade', currentQuantidade);

  fetch('/api/criar-pedido/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken()
    },
    body: formData
  })
  .then(function(response) { return response.json(); })
  .then(function(data) {
    if (data.success) {
      currentPedidoId = data.pedido_id;
      document.getElementById('hiddenPedidoId').value = currentPedidoId;
      
      if (data.premios_ganhos && data.premios_ganhos.length > 0) {
        var premiosMsg = 'Parab√©ns! Voc√™ ganhou pr√™mios:\n';
        for (var i = 0; i < data.premios_ganhos.length; i++) {
          var p = data.premios_ganhos[i];
          premiosMsg += 'üéâ N√∫mero ' + p.numero + ': R$ ' + p.valor.toFixed(2) + '\n';
        }
        alert(premiosMsg);
      }
      
      document.getElementById('stepCpfVerification').style.display = 'none';
      document.getElementById('stepPaymentProcessing').style.display = 'block';
      
      gerarQRCode();
    } else {
      console.error('Erro ao criar pedido:', data.error);
      alert(data.error || 'Erro ao criar pedido');
      
      btnPagar.disabled = false;
      btnPagar.innerHTML = '<i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento';
    }
  })
  .catch(function(error) {
    console.error('Erro na requisi√ß√£o criar pedido:', error);
    alert('Erro ao processar pagamento');
    
    btnPagar.disabled = false;
    btnPagar.innerHTML = '<i class="fas fa-credit-card me-2"></i>Gerar PIX para Pagamento';
  });
}

// Gerar QR Code
function gerarQRCode() {
  if (!currentPedidoId) {
    console.error('currentPedidoId n√£o definido');
    return;
  }

  fetch('/api/gerar-qr/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken()
    },
    body: JSON.stringify({
      pedido_id: currentPedidoId
    })
  })
  .then(function(response) { return response.json(); })
  .then(function(data) {
    document.getElementById('qrLoading').style.display = 'none';
    
    if (data.success) {
      if (data.qr_code_base64) {
        var img = document.getElementById('modalQrImg');
        img.src = 'data:image/png;base64,' + data.qr_code_base64;
        document.getElementById('modalQrImage').style.display = 'block';
      }
      
      if (data.qr_code) {
        document.getElementById('modalQrRaw').textContent = data.qr_code;
        document.getElementById('pixCodeContainer').style.display = 'block';
      }
      
      document.getElementById('btnCheckStatus').style.display = 'inline-block';
      startPaymentCheck();
      
    } else {
      console.error('Erro ao gerar QR:', data.error);
      alert(data.error || 'Erro ao gerar QR Code');
    }
  })
  .catch(function(error) {
    console.error('Erro ao gerar QR:', error);
    document.getElementById('qrLoading').style.display = 'none';
    alert('Erro ao gerar QR Code');
  });
}

// Verificar status do pagamento
function checkPaymentStatus() {
  if (!currentPedidoId) return;

  fetch('/api/pedido/' + currentPedidoId + '/status/')
  .then(function(response) { return response.json(); })
  .then(function(data) {
    if (data.success && data.status === 'pago') {
      alert('Pagamento confirmado! Recarregando p√°gina...');
      setTimeout(function() {
        window.location.reload();
      }, 2000);
    }
  })
  .catch(function(error) {
    console.error('Erro ao verificar pagamento:', error);
  });
}

// Verifica√ß√£o autom√°tica do pagamento
function startPaymentCheck() {
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
  }
  
  paymentCheckInterval = setInterval(function() {
    checkPaymentStatus();
  }, 10000);
}

// Copiar c√≥digo PIX
function copyPixCode() {
  var pixCode = document.getElementById('modalQrRaw').textContent;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(pixCode).then(function() {
      alert('C√≥digo PIX copiado!');
    }).catch(function(err) {
      console.error('Erro ao copiar:', err);
      fallbackCopyTextToClipboard(pixCode);
    });
  } else {
    fallbackCopyTextToClipboard(pixCode);
  }
}

// Fallback para copiar texto
function fallbackCopyTextToClipboard(text) {
  var textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.opacity = '0';
  document.body.appendChild(textArea);
  textArea.select();
  textArea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('C√≥digo PIX copiado!');
  } catch (err) {
    console.error('Erro ao copiar:', err);
    alert('N√£o foi poss√≠vel copiar automaticamente. Por favor, copie manualmente.');
  }
  
  document.body.removeChild(textArea);
}

// Download do QR Code
function downloadQR() {
  var img = document.getElementById('modalQrImg');
  var link = document.createElement('a');
  link.download = 'qrcode-pix.png';
  link.href = img.src;
  link.click();
}

// Reset CPF
function resetarCpfPagamento() {
  document.getElementById('payCpf').value = '';
  document.getElementById('payUserBox').style.display = 'none';
  document.getElementById('payActions').style.display = 'none';
  document.getElementById('payUserNotFound').style.display = 'none';
  document.getElementById('payCpfInvalid').style.display = 'none';
  
  document.getElementById('payCpf').focus();
}

// Valida√ß√£o de CPF
function isValidCPF(digits) {
  if (!digits || digits.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(digits)) return false;
  
  var nums = [];
  for (var i = 0; i < digits.length; i++) {
    nums.push(parseInt(digits[i], 10));
  }

  var sum = 0;
  for (var i = 0; i < 9; i++) {
    sum += nums[i] * (10 - i);
  }
  var rev = (sum * 10) % 11;
  if (rev === 10) rev = 0;
  if (rev !== nums[9]) return false;

  sum = 0;
  for (var i = 0; i < 10; i++) {
    sum += nums[i] * (11 - i);
  }
  rev = (sum * 10) % 11;
  if (rev === 10) rev = 0;
  if (rev !== nums[10]) return false;

  return true;
}

// Obter CSRF Token
function getCsrfToken() {
  var cookieValue = document.querySelector('[name=csrfmiddlewaretoken]');
  return cookieValue ? cookieValue.value : '';
}

// M√°scara para CPF
document.addEventListener('DOMContentLoaded', function() {
  var cpfInput = document.getElementById('payCpf');
  if (cpfInput) {
    cpfInput.addEventListener('input', function(e) {
      var value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value;
    });
  }
});

// Eventos de fechar modal
window.addEventListener('click', function(e) {
  var backdrop = document.getElementById('paymentBackdrop');
  if (e.target === backdrop) { 
    closePaymentModal(); 
  }
});

window.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closePaymentModal(); 
});